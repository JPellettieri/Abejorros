---
title: 'TP final: Efecto de Cafeína y Arginina en la formación de memoria a largo
  plazo de abejorros'
author: "Julieta Pellettieri, Valentino Morazzo Nunzi" #Pongan sus nombres acá
date: "11/10/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(readxl)
library(lme4)
library(ggplot2)     
library(dplyr)      
library(car)        
library(glmmTMB)     
library(DHARMa)      
library(performance) 
library(emmeans)     
library(ggeffects)   
library(sjPlot)
#setwd("E:/Juli/Abejorros") #setwd de la compu de Lau
setwd("F:/Juli/Documents/Abejorros y Abejas/Abejorros")
Datos <- read_excel("Datos prueba.xlsx",col_names = TRUE,  sheet = "Limpio")




```

## Introducción:

En la actualidad el incremento en la producción agropecuaria mediante prácticas sustentables se volvió una prioridad. La polinización dirigida es una estrategia en desarrollo que consiste en condicionar polinizadores como abejas y abejorros para aumentar la producción de frutales. La mayoría de los estudios para perfeccionar esta técnica se llevaron a cabo en Apis Mellifera por ser una especie accesible, de uso generalizado y con un alto grado de domesticación. En los mismos se encontraron que compuestos presentes naturalmente en concentraciones trazas en el néctar de las plantas como la cafeína y la Arginina favorecen la formación de memorias a largo término.
Bombus Pauloensis es una especie de abejorro nativa de Argentina empleada para la polinización dirigida. Sin embargo, debido a su alto costo, difícil manejo e inaccesibilidad es  una especie poco estudiada. Con el objetivo de mejorar la performance de esta especie en las prácticas de polinización dirigida se busca evaluar el impacto de la cafeína y la arginina en la formación de memoria a largo término. 


## Descripción del ensayo:
 En este contexto a lo largo del año 2024 se realizó un ensayo experimental en el Campo Experimental de la Facultad de Ciencias Exactas y Naturales de la Universidad de Buenos Aires, Argentina. El cual involucró en el uso de 6 nidos industriales de los cuales solo 4 fueron posibles evaluar debido al difícil manejo de la especie. Cada nido fue evaluado durante el periodo que duró activo, luego se continuaron los ensayos con el nido siguiente por lo tanto en cada día de ensayo salvo los días de transición entre nidos suele evaluarse individuos perteneciente al mismo nido. 
El ensayo consistió en un entrenamiento asociativo clásico con 6 exposiciones a Lionanol (un compuesto aromático presente en cientos de flores) seguidas de una recompensa, la misma consistía en solución azucarada 50% p/p a la cual según el tratamiento se le agregaba a la solución cafeína (0,15 mM) (CAF), arginina (0,03 mM) (ARG), ninguno (SIN CNA) o ambos compuestos (CAF+ARG). También se contó con un grupo control el cual fue recompensado 6 veces sin ser expuesto al olor (SIN OLOR). En cada exposición el individuo puede elegir tomar la recompensa o no, solo aquellos individuos que consumieron la recompensa al menos 3 veces fueron considerados entrenados.
A las 24 hs de realizado el entrenamiento se evaluó la respuesta de los individuos mediante un ensayo PRE (Respuesta de Extensión de Probóscide). El mismo consiste en exponer al abejorro al olor conocido (en este caso Lionanol) y a un olor novedoso (Nonanal) y evaluar en cada exposición si el individuo extiende la probóscide a la espera de la recompensa o no. Solo aquellos individuos que a las 24hs extienden la probóscide en presencia de Lionanol y no en presencia de Nonanal son considerados como que recuerdan el olor enseñado en el entrenamiento, a partir de esta información se definió la variable dicotómica “Recuerda”.

### Condicionamiento de la base de datos

```{r BD, echo=TRUE}
Datos$Tratamiento<- as.factor(Datos$Tratamiento)
Datos$Nido<- as.factor(Datos$Nido)
summary (Datos$Tratamiento) # para ver el N de cada tratamiento

#Contar el número de veces que los abejorros tomaron la recompensa (T) en las exposiciones (E1 a E6) (o aprendieron "A")
Datos <- Datos %>% 
  rowwise() %>%
  mutate(Condicionamiento = sum(c_across(E1:E6) == "T" | c_across(E1:E6) == "A"))

#Defino variable respuesta, Recuerda
Datos <- Datos %>%
  rowwise() %>%
  mutate(Recuerda = if_else(`LIO 24hs` == 1 & `NONA 24 hs` == 0, 1, 0))

Datos <- Datos %>%
  filter(Condicionamiento > 0, Muere == 0)

# Filtrar para los que tomaron al menos 3 veces y sobrevivieron. "Criterio de experto".
Filt_3 <- Datos %>%
  filter(Condicionamiento >= 3, Muere == 0)


```

### Análisis exploratorio de los datos.
Es de esperar que una mayor cantidad de ingestas en la etapa de condicionamiento se vea asociada a una mayor probabilidad de formar memorias a largo plazo. Normalmente se considera que con 3 ingestas el individuo es capaz de formar una asociación estímulo-recompensa. Los datos apoyan el criterio de experto tomado.

```{r ingestas, echo=FALSE}
Ingestas <- Datos %>%
  group_by(Condicionamiento) %>%
  summarise(Probabilidad = mean(Recuerda)*100, n = n())
print (Ingestas)
# Graficar la probabilidad
ggplot(Ingestas, aes(x = as.factor(Condicionamiento), y = Probabilidad)) +
  geom_col(fill = "orange") +
  labs(title = "Probabilidad de recordar el olor a las 24hs en función de el la cantidad de ingestas en el entrenamiento",
       x = "Cantidad de ingestas",
       y = "Probabilidad de responder al PER (%)") +
  theme_minimal()  #corregir para que tomas=2 tambien lo grafique
```

#### Analisis de las variables aleatorias

Para evaluar la naturaleza de las variables aleatorias Nido y Día se realizaron sus correspondientes spaguetti plots.

Nido:
```{r nidos, echo=FALSE}
#Los datos Sin olor no los vamos a incluir en el modelo asique los borro
DatosMemoria <- Filt_3 %>%
  filter(Tratamiento != "SIN OLOR")
#####HAgo spagetti plot para evaluar los distintos nidos #########
table (Datos$Nido,Datos$Tratamiento)# n de cada tratamiento para cada nido
# Calcular la tasa de aprendizaje promedio por tratamiento
TasaAprendizaje <- DatosMemoria %>%
  group_by(Tratamiento, Nido) %>%
  summarise(TasaPromedio = mean(Recuerda, na.rm = TRUE), .groups = "drop")
# Spaghetti-plot de las tasas de aprendizaje por Nido
ggplot(TasaAprendizaje, aes(x = Tratamiento, y = TasaPromedio, colour = factor(Nido), group = Nido)) +
  labs(title = "Tasa Promedio de Aprendizaje por Tratamiento según el nido ",
       x = "Tratamiento",
       y = "Tasa de Aprendizaje Promedio") +
  geom_point() +
  geom_line() +
  theme_bw()

```


En el gráfico se evidencia que el nido 4 no sigue las tendencias presentadas por los otros nidos. Esto se puede explicar por el período en el cual se tomaron los datos de este nido, ya que el mismo fue evaluado entre el 25/3 y el 17/4. Naturalmente los nidos de abejorro a fines del verano mueren y la reina hiberna hasta el próximo periodo de floración. Por lo tanto es de esperar que en Otoño su actividad se vea alterada y menor a la usual. 
Si observamos la cantidad de individuos evaluada para cada tratamiento vemos que este nido no solo no se sometió a todos los tratamientos sino también presenta un N=3 mucho menor al resto de los nidos. En este contexto se decidió descartar estos datos.

```{r nido 4, echo=FALSE}
summary(Datos$Nido) #Cantidad de datos por nido
Nido4<- DatosMemoria%>%
  filter(Nido == "4")
summary(Nido4$Tratamiento)
#Sacamos al nido 4
DatosMemoria<- DatosMemoria%>%
  filter(Nido != "4")
```
Día:
Se consideró usar día como variable de efectos aleatorios pero al no realizarse de manera ordenada todos los tratameitnos por dia y el uso de un solo nido por día dificultan su uso como VA.

```{r Día, echo=FALSE}
### Spagetti plot por dia ###
TasaAprendizaje <- DatosMemoria %>%
  group_by(Tratamiento,Dia) %>%
  summarise(TasaPromedio = mean(Recuerda, na.rm = TRUE), .groups = "drop")
print(TasaAprendizaje)
#Grafico
ggplot(TasaAprendizaje, aes(x = Tratamiento, y = TasaPromedio, colour = factor(Dia), group = Dia)) +
  labs(title = "Tasa de Aprendizaje por Tratamiento",
       x = "Tratamiento",
       y = "Tasa de Aprendizaje Promedio") +
  geom_point() +
  geom_line() +
  theme_bw()

```


#### Analisis exploratorio del porcentaje de respuesta en funcion del tratamiento

```{r VR, echo=FALSE}
Respuesta <- Filt_3 %>%
  group_by(Tratamiento) %>%
  summarise(
    Responden = sum(`LIO 24hs` == 1 & `NONA 24 hs` == 0),      # Cuenta cuántos tienen LIO 24hs igual a 1
    Total = n_distinct(N),                 # Reemplaza "N" por el nombre correcto de la columna de ID única
    Porcentaje = (Responden / Total) * 100, # Calcula el porcentaje de respuesta
    .groups = "drop"
  )
print(Respuesta)

```
Los datos muestran que los abejorros estudiados que fueron sometidos a recompensas con concentraciones traza de Arginina y/o cafeina tienen una mayor tasa de respuesta a la evalucion de PER realizada a las 24hs. Tambien se puede destacar un porcentaje de respuesta mayor en los individuos que consumiero ambos compuestos al simultaneo. Por ultimo el control "sin olor" no muestra ningun individuo que responda a la evaluacion PER afirmando que el protocolo aplicado fue adecuado.


```{r VRgrafico, echo=FALSE}
# Graficar las respuestas en porcentaje según el tratamiento
library(ggplot2)
ggplot(Respuesta, aes(x = Tratamiento, y = Porcentaje)) +
  geom_bar(stat = "identity") +
  labs(title = "Porcentaje de Abejorros respondieron a PER en funcion del tratamiento",
       x = "Tratamiento",
       y = "Porcentaje (%)") +
  theme_minimal()
```


### Modelo
Se plantea un modelo de comparación de medias con:
  - Tratamiento como variable de efectos fijos cualitativa con 4 niveles (CAF, ARG, CAF+ARG y SIN CNA)
  - Nido como variable cualitativa de efectos aleatorio con tres niveles (2,5 y 6) 
  - Respuesta al PER como variable respuesta dicotomica (1= extencion de proboscide solo a Lionanol, 0= no extencion al Lionanol o extension a Lionanol y al Nonanal) 
  Se espera que la VR ajuste a distibucion de tipo Bernoulli.
```{r Modelo mixto VA nido, echo=TRUE}
MMixtoNido<- glmer(Recuerda~Tratamiento+(1|Nido), data=DatosMemoria, family=binomial)
```

#### Supuestos
-> poner aca cuales son los supuestos del modelo
Se pusieron a prueba los supuestos del modelo empleando el paquete DHARMA
```{Supuestos, echo=FALSE}
simm1 <- simulateResiduals(fittedMod = MMixtoNido)
plot(simm1)
testDispersion(simm1)
```
